name: JSON Validation and MkDocs Deployment

on:
  pull_request:
    paths:
      - '*.json'
      - 'docs/**'
      - 'mkdocs.yml'
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-json:
    name: Validate JSON
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Validate JSON syntax and required fields
        run: |
          set -e
          for file in *.json; do
            if [ -f "$file" ]; then
              echo "Validating $file..."

              # Syntax check
              if ! jq empty "$file" 2>/dev/null; then
                echo "Syntax error detected in $file."
                exit 1
              fi

              # Schema check: required fields in each object
              missing_fields=false
              length=$(jq 'length' "$file" 2>/dev/null || echo 0)
              for i in $(seq 0 $((length - 1))); do
                for field in id title date author content; do
                  if ! jq -e ".[$i] | has(\"$field\")" "$file" >/dev/null 2>&1; then
                    echo "ERROR: $file object #$i is missing required field: $field"
                    missing_fields=true
                  fi
                done
              done

              if [ "$missing_fields" = true ]; then
                exit 1
              fi

              echo "âœ… $file passed syntax and schema validation!"
            fi
          done

  deploy-mkdocs:
    name: Build and Deploy MkDocs
    needs: validate-json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material

      - name: Build MkDocs
        run: mkdocs build

      - name: Clean Search Index
        run: |
          python -c "
          import json
          import os
          search_index_path = os.path.join('site', 'search', 'search_index.json')
          if os.path.exists(search_index_path):
              with open(search_index_path, 'r') as f:
                  search_index = json.load(f)
              for doc in search_index['docs']:
                  doc['text'] = ''
              with open(search_index_path, 'w') as f:
                  json.dump(search_index, f, indent=2)
          "
